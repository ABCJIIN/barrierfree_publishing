<?php 
include_once __DIR__.'/../../config/common.php';
include_once __DIR__ . '/../../languages/_lang.digital_map.php';

// 임시
$lang = $_GET['lang'] ?? 'kor';   

$q = '';
if (isset($_GET['q']) ) { 
    $q = $_GET['q']; 
}

if (!isset($language[$lang])) {
    $lang = 'kor';
}

// 언어 데이터
$language_data = $language[$lang]['digital_map'];


$group = $_GET['group'] ?? 1;

$lowMode = $_COOKIE['lowMode'] ?? null;
$perPage = ($lowMode === '1') ? 3 : 9;
$cpage = isset($_GET['page']) ? (int)$_GET['page'] : 1;

// 리스트

$themeList = getDgimapThemList($lang);
$list = getDgimapList($group,$lang,$q,$cpage,$perPage);

$total        = $list['total'];
$currentPage  = max(1, (int)$cpage);
$totalPages   = (int)ceil($total / $perPage);

/*echo "<pre>";
echo print_r($themeList);
echo "</pre>";*/

/*echo "<pre>";
echo print_r($list);
echo "</pre>";*/

?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART TOURIST INFORMATION</title>
    <script src="<?= asset('/assets/js/idleTimer.js') ?>"></script>

    <script>
        (function () {
            try {
                var contrast = localStorage.getItem('contrastMode'); // '1' | '0' | null
                var low      = localStorage.getItem('lowMode');      // '1' | '0' | null
                var voice      = localStorage.getItem('voiceMode');      // '1' | '0' | null
                var last     = localStorage.getItem('lastMode');     // 'contrast' | 'low' | 'none' | null
                var html     = document.documentElement;

                function applyContrast() {
                    html.classList.add('mode-high-contrast');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-voice');
                }

                function applyLow() {
                    html.classList.add('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                    html.classList.remove('mode-voice');
                }

                function applyVoice() {
                    html.classList.add('mode-voice');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                }

                // 1) lastMode 기준으로 우선 적용
                if (last === 'contrast' && contrast === '1') {
                    applyContrast();
                } else if (last === 'low' && low === '1') {
                    applyLow();
                } else if (last === 'voice' && voice === '1') {
                    applyVoice();
                } else {
                    // 2) lastMode 정보가 없거나 꼬였을 때, storage 값으로 복구
                    if (contrast === '1' && low !== '1' && voice !== '1') {
                        applyContrast();
                        localStorage.setItem('lastMode', 'contrast');
                    } else if (low === '1' && contrast !== '1' && voice !== '1') {
                        applyLow();
                        localStorage.setItem('lastMode', 'low');
                    } else if (voice === '1' && contrast !== '1' && low !== '1') {
                        applyVoice();
                        localStorage.setItem('lastMode', 'voice');
                    } else {
                        // 둘 다 1이거나 둘 다 0/없음 → 안전하게 일반 모드
                        html.classList.remove('mode-low-posture');
                        html.classList.remove('mode-high-contrast');
                        html.classList.remove('mode-voice');
                        localStorage.setItem('lastMode', 'none');
                    }
                }
            } catch (e) {
                // localStorage 사용 불가 시 그냥 무시
            }
        })();
    </script>

    <link rel="stylesheet" href="<?= asset('/assets/scss/vendors/swiper-bundle.min.css') ?>">
    <link rel="stylesheet" href="<?= asset('/assets/scss/main.css') ?>">

    <script src="<?= asset('/assets/js/vendor/jquery-3.7.1.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/vendor/swiper-bundle.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/common.js') ?>"></script>
    <script src="<?= asset('/assets/js/zoom.js') ?>"></script>
    <script src="<?= asset('/assets/js/tab.js') ?>"></script>
    <script src="<?= asset('/assets/js/select.js') ?>"></script>
    <script src="<?= asset('/assets/js/modal.js') ?>"></script>
    <script src="<?= asset('/assets/js/filter.js') ?>"></script>
    <script src="<?= asset('/assets/js/volume.js') ?>"></script>
</head>
<body data-tts-summary="지도 화면입니다. 지역을 선택해 상세 내용을 확인하세요.">
    <div class="zoom-viewport" aria-label="확대 가능한 화면">
        <div class="zoom-move-wrap h917">
            <div class="zoom-canvas">
                <div class="modal-background">
                <!-- header -->
                <header class="header">
                    <?php include __DIR__.'/../../html/include/header.html'; ?>
                </header>
                <!-- //header -->
                
                <!-- sub header -->
                <div class="sub-header">
                    <div class="sub-hd-inner">
                        <h2 class="page-title">지도</h2>
                    </div>
                </div>
                <!-- //sub header -->
                
                <!-- main -->
                <main class="main map">
                    <div class="detail-title">
                        <h3>디지털 관광지도</h3>
                    </div>

                    <div class="filter-menu">
                        <ul class="filter-list" role="radiogroup" tabindex="1" aria-label="지역 그룹 선택입니다. 원하는 그룹을 선택하세요.">
                            <?php for($i=1; $i<= 7; $i++){ 
                                $groupTitle = trim($language_data['local_title' . $i] ?? '');
                            ?>
                            <li class="<?php if($i==$group) echo "is-active"; ?>" >
                                <button type="button" role="radio" aria-checked="false" class="filter-btn" data-group="<?= $i; ?>"><?= $groupTitle ?></button>
                            </li>
                            <?php } ?>
                        </ul>
                        <div class="filter-cont">
                            <!-- 테마 버튼 -->
                            <div class="thema-btn-wrap">
                                <!-- 251121 개발 시 href 실제 URL로 변경 필요 -->
                                <a href="javascript:void(0)" class="thema-btn card-link" aria-label="추천 테마입니다. <?= $themeList[0][0]['title']; ?> 상세 정보 보기" data-title="<?= $themeList[0][0]['title']; ?>" data-desc="<?= strip_tags($themeList[0][0]['story'] ?? '') ?>" data-theme="kdh"><?= $themeList[0][0]['title']; ?></a>
                                <a href="javascript:void(0)" class="thema-btn card-link" aria-label="추천 테마입니다. <?= $themeList[0][1]['title']; ?> 상세 정보 보기" data-title="<?= $themeList[0][1]['title']; ?>" data-desc="<?= strip_tags($themeList[0][1]['story'] ?? '') ?>" data-theme="top100"><?= $themeList[0][1]['title']; ?></a>
                            </div>
                            <!-- 디지털 관광지도 리스트 출력 영역 -->
                            <section class="filter-panel">
                                <ul class="card-list" aria-label="디지털 관광지도 목록">
                                    <?php 
                                    foreach($list[$group] as $val){ 
                                        $displayName = $val['title'] ?? '';
                                        if($displayName === '') continue;
                                    ?>
                                    <li class="card">
                                        <!-- 251121 개발 시 aria-label은 장소명 기반으로 동적 생성 필요: "{장소명} 상세 정보 보기" -->
                                        <a class="card-link" href="javascript:void(0)" aria-label="<?= $displayName; ?> 상세 정보 보기" data-title="<?= $displayName; ?>" data-desc="<?= strip_tags($val['story'] ?? '') ?>">
                                            <div class="card-thumbnail">
                                                <!-- 251121 개발 시 alt는 장소명 기반으로 동적 생성 필요: "{장소명} 이미지" -->
                                                <img src="../../assets/images/map/<?=  $val['attachment_file1'];  ?>" alt="<?= $displayName; ?> 이미지">
                                            </div>
                                            <div class="card-info">
                                                <h3 class="card-title"><?= $displayName; ?></h3>
                                            </div>
                                        </a>
                                    </li>
                                    <?php } ?>
                                </ul>
                            </section>
                        </div>
                            <?php if($lowMode == 1) { ?>                     
                            <?php if ($totalPages > 1){ ?>
                            <div class="pagination" role="navigation" aria-label="페이지 이동">
                            <!-- 251121 개발 시 낮은 자세 모드에서만 사용 -->   
                             <?php
                                    $pagination = new Zebra_Pagination();
                                    $pagination->records($list['total']);
                                    $pagination->records_per_page($perPage);

                                    $pagination->render();
                            ?>
                            </div>
                            <?php } ?>
                            <?php } ?>
                    </div>
                </main>
                <!-- //main -->

                <!-- bottom nav -->
                <nav class="bottom-nav" aria-label="하단 주요 메뉴">
                    <?php include __DIR__.'/../../html/include/bottom_nav.html'; ?>
                </nav>
                <!-- bottom nav -->
                 
                </div>

                <!-- 공통 모달 -->
                <div class="global-modal-wrap">
                    <?php include __DIR__.'/../../html/include/modal.html'; ?>
                    <!-- 251121 개발 시: 모달 제어는 반드시 javascript:void(0) / closeModal() 공통 함수로만 처리해야 함.
                    클래스/aria-hidden 직접 토글 시 포커스 트랩, 배경 포커스 잠금, ESC 닫기 등이 동작하지 않음 -->
                    <!-- modal -->
                    <div class="modal digital-map" aria-hidden="true">
                        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="digitalMapModalTitle">
                            <div id="digitalMapModalTitle" class="modal-title">
                                <strong>안동</strong>
                            </div>
                            <p class="qr-desc">
                                강원 고성은 DMZ와 통일 전망대, 깨끗한 해변과 설악산 자락이 어우러진 곳으로, <br>
                                자연과 안보 관광이 함께하는 특별한 여행지입니다. 화진포와 송지호 같은 자연 그대로의 <br>
                                풍경이 인상적이며, 조용한 휴식을 원하는 여행객에게 제격입니다.
                            </p>
                            <div class="qr-area">
                                <div class="qr-info-wrap">
                                    <strong class="qr-info-title">
                                        QR코드 스캔을 통해 모바일로 확인하세요.
                                    </strong>
                                    <ul class="qr-guide-list">
                                        <li class="qr-guide-item">
                                            스캔 방법 : 휴대폰 카메라 앱 실행 → QR코드 이미지 스캔
                                        </li>
                                        <li class="qr-guide-item">
                                            Wi-Fi Zone이 아닌 경우 데이터 요금제에 따라 추가 요금이<br> 부과될 수 있습니다.
                                        </li>
                                    </ul>
                                </div>
                                <div class="qr-wrap">
                                    <div class="qr-code">
                                        <!-- 251121 개발 시 alt는 장소명 기반으로 동적 생성 필요: "{장소명} 지도 정보 QR코드" -->
                                        <img src="../../assets/images/dummy/google_maps_qr.png" alt="안동 지도 정보 QR코드">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-btn-wrap">
                                <button type="button" class="close-btn">닫기</button>
                            </div>
                        </div>
                    </div>
                    <!-- //modal -->
                </div>
                <!-- //공통 모달 -->
                
                <!-- footer -->
                <footer class="footer">
                    <?php include __DIR__.'/../../html/include/footer.html'; ?>
                </footer>
                <!-- //footer -->                
            </div>

            <!-- 251215 로딩화면 추가 -->
            <!-- 로딩화면 -->
            <div class="loading is-hidden" role="status" aria-live="polite" aria-atomic="true">
                <?php include __DIR__.'/../include/loading.html'; ?>
            </div>

            <!-- 상하좌우 이동 버튼 -->
            <div class="viewport-controller">
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-up" aria-label="위로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">위로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-left" aria-label="좌측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">좌측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-right" aria-label="우측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">우측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-down" aria-label="아래로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">아래로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control zoom-exit-btn">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">돋보기 종료</span>
                    </button>
                </div>
            </div>
            <!-- //상하좌우 이동 버튼 -->
        </div>
    </div>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.filter-btn');

    buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
            const group = this.getAttribute('data-group');

            const url = new URL(window.location.href);
            url.searchParams.set('group', group);
            url.searchParams.set('page', 1);

            window.location.href = url.pathname + '?' + url.searchParams.toString();
        });
    });
});
</script>