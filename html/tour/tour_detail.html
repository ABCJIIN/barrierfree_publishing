
<?php 
include_once __DIR__.'/../../config/common.php';
include_once __DIR__ . '/../../languages/_lang.accessibletoure.php';

$GLOBALS['lang'] = $GLOBALS['lang'] ?? 'kor';
$GLOBALS['lang_code'] = $GLOBALS['lang_code'] ?? 0;
// 관광지 정보
/*$query = "
    SELECT *
    FROM VW_NP_TOUR_KOR_V2
    WHERE id = {$_GET['id']}
";*/
$query = "
		SELECT nta2.*, 'A' as cat1
		FROM NP_tour_api_v2 nta2
		WHERE id = {$_GET['id']}
	";
$result = dbaccess($query);

$row = mysqli_fetch_assoc($result);


// 인근 지하철, 연락처
if ($row['cat1'] == 'A' || $row['cat1'] == 'S') {
    $R_is_station   = getStationsFront('tour_api', $row['master_id'], true);

    $A_aux  = getAuxInfo($row['master_id']);

    if (is_array($A_aux) && !empty($A_aux['phone'])) {
        $T_phone = replacePhoneNumber($A_aux['phone']);
    } else {
        $T_phone = '-';
    }
}
/*if ($row['cat1'] == 'T') {
    $R_is_station 		= getStationsFront('tour', $row['id'], true);
    $T_phone = replacePhoneNumber($row['phone']);
}*/

//무장애 픽토그램 찾기 
$course_num = 0;
if ((int)$row['master_id'] > 0){
    $course_type = 1;
    $course_seq = (int)$row['master_id'];
    $course_num = (int)$row['id'];
} else {
    $course_type = 2;
    $course_seq = (int)$row['id'];
    $course_num = (int)$row['id'];
}

$rsPictogram = getBarrierfreeData($course_seq ,$row['lang'] , $course_type);
$categories = [
    'physical' => [
        'title' => $language[$GLOBALS['lang']]['accessibletour']['story']['pictotitle']['pictit01'],
        'start' => 0,
        'end'   => 10
    ],
    'visual' => [
        'title' => $language[$GLOBALS['lang']]['accessibletour']['story']['pictotitle']['pictit02'],
        'start' => 11,
        'end'   => 18
    ],
    'hearing' => [
        'title' => $language[$GLOBALS['lang']]['accessibletour']['story']['pictotitle']['pictit03'],
        'start' => 19,
        'end'   => 22
    ],
    'family' => [
        'title' => $language[$GLOBALS['lang']]['accessibletour']['story']['pictotitle']['pictit04'],
        'start' => 23,
        'end'   => 99
    ],
];
$grouped = [];

$strPictoGram_text = ''; 
$strPictoGram = ''; 
if ($rsPictogram) {
    $picSeq = 0;

    foreach ($rsPictogram as $field => $sVal) {
        if (trim($sVal) === '') {
            $picSeq++;
            continue;
        }

        foreach ($categories as $key => $cat) {
            if ($picSeq >= $cat['start'] && $picSeq <= $cat['end']) {
                $grouped[$key][] = [
                    'icon' => $field,
                    'text' => $sVal
                ];
                break;
            }
        }

        $picSeq++;
    }
}
foreach ($categories as $key => $cat) {
    if (empty($grouped[$key])) continue;

    $strPictoGram .= '<div class="access-item">';
    $strPictoGram .= '<h5 class="access-title">'.$cat['title'].'</h5>';
    $strPictoGram .= '<ul class="access-list">';

    foreach ($grouped[$key] as $item) {
        $strPictoGram .= '<li>';
        $strPictoGram .= '<span class="icon_'.$item['icon'].'"></span>';
        $strPictoGram .= $item['text'];
        $strPictoGram .= '</li>';
        $strPictoGram_text .= $item['text']."."; 
    }

    $strPictoGram .= '</ul></div>';
}

$T_station_line = [
    // 수도권 1~9호선
    '1'  => '1호선', '2'  => '2호선', '3'  => '3호선', '4'  => '4호선', '5'  => '5호선', '6'  => '6호선', '7'  => '7호선', '8'  => '8호선', '9'  => '9호선',

    // 인천 도시철도
    'I'  => '인천 1호선', 'I2' => '인천 2호선',

    // 수도권 광역·민자
    'S'  => '신분당선', 'K'  => '경의·중앙선', 'G'  => '경춘선', 'SU' => '수인·분당선', 'A'  => '공항철도', 'U'  => '의정부 경전철', 'KK' => '경강선', 'UI' => '우이신설선', 'ML' => '김포골드라인', 'WS' => '서해선', 'SUB'=> 'GTX-A',

    // 부산
    'B1' => '부산 1호선', 'B2' => '부산 2호선', 'B3' => '부산 3호선', 'B4' => '부산 4호선', 'BD' => '부산 동해선', 'BJ' => '부산 김해경전철',

    // 대구
    'D1' => '대구 1호선', 'D2' => '대구 2호선', 'D3' => '대구 3호선',

    // 대전
    'DJ1' => '대전 1호선',

    // 광주
    'GJ1' => '광주 1호선',
];
$T_station_text = "";
$T_station = "";


?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART TOURIST INFORMATION</title>
    <script src="<?= asset('/assets/js/idleTimer.js') ?>"></script>

    <script>
        (function () {
            try {
                var contrast = localStorage.getItem('contrastMode'); // '1' | '0' | null
                var low      = localStorage.getItem('lowMode');      // '1' | '0' | null
                var voice      = localStorage.getItem('voiceMode');      // '1' | '0' | null
                var last     = localStorage.getItem('lastMode');     // 'contrast' | 'low' | 'none' | null
                var html     = document.documentElement;

                function applyContrast() {
                    html.classList.add('mode-high-contrast');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-voice');
                }

                function applyLow() {
                    html.classList.add('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                    html.classList.remove('mode-voice');
                }

                function applyVoice() {
                    html.classList.add('mode-voice');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                }

                // 1) lastMode 기준으로 우선 적용
                if (last === 'contrast' && contrast === '1') {
                    applyContrast();
                } else if (last === 'low' && low === '1') {
                    applyLow();
                } else if (last === 'voice' && voice === '1') {
                    applyVoice();
                } else {
                    // 2) lastMode 정보가 없거나 꼬였을 때, storage 값으로 복구
                    if (contrast === '1' && low !== '1' && voice !== '1') {
                        applyContrast();
                        localStorage.setItem('lastMode', 'contrast');
                    } else if (low === '1' && contrast !== '1' && voice !== '1') {
                        applyLow();
                        localStorage.setItem('lastMode', 'low');
                    } else if (voice === '1' && contrast !== '1' && low !== '1') {
                        applyVoice();
                        localStorage.setItem('lastMode', 'voice');
                    } else {
                        // 둘 다 1이거나 둘 다 0/없음 → 안전하게 일반 모드
                        html.classList.remove('mode-low-posture');
                        html.classList.remove('mode-high-contrast');
                        html.classList.remove('mode-voice');
                        localStorage.setItem('lastMode', 'none');
                    }
                }
            } catch (e) {
                // localStorage 사용 불가 시 그냥 무시
            }
        })();
    </script>

    <link rel="stylesheet" href="<?= asset('/assets/scss/vendors/swiper-bundle.min.css') ?>">
    <link rel="stylesheet" href="<?= asset('/assets/scss/main.css') ?>">
    <!-- 픽토그램 이미지 css -->
    <link rel="stylesheet" href="<?= asset('/assets/scss/barrier_free_pictogram.css') ?>">

    <script src="<?= asset('/assets/js/vendor/jquery-3.7.1.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/vendor/swiper-bundle.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/common.js') ?>"></script>
    <script src="<?= asset('/assets/js/zoom.js') ?>"></script>
    <script src="<?= asset('/assets/js/tab.js') ?>"></script>
    <script src="<?= asset('/assets/js/select.js') ?>"></script>
    <script src="<?= asset('/assets/js/sectionMove.js') ?>"></script>
    <script src="<?= asset('/assets/js/modal.js') ?>"></script>
    <script src="<?= asset('/assets/js/volume.js') ?>"></script>

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=1mizviwsce"></script>
</head>
<body data-tts-summary="관광지 상세입니다. 정보를 확인하세요.">
    <div class="zoom-viewport" aria-label="확대 가능한 화면">
        <div class="zoom-move-wrap h917">
            <div class="zoom-canvas">
                <div class="modal-background">
                <!-- header -->
                <header class="header">
                    <?php include __DIR__.'/../../html/include/header.html'; ?>
                </header>
                <!-- //header -->
                
                <!-- sub header -->
                <div class="sub-header">
                    <div class="sub-hd-inner">
                        <h2 class="page-title">관광</h2>
                    </div>
                </div>
                <!-- //sub header -->
                
                <!-- main -->
                <main class="main detail-page">
                    <!-- 251205 1차 수정 : 버튼 추가 -->
                    <div class="detail-title">
                        <button type="button" class="nav-btn prev" aria-label="이전 페이지로 이동"></button>
                        <h3><?= $row['title']; ?></h3>
                    </div>
                    <!-- //1차 수정 -->
                    <div class="scroll-sec">
                        <!-- 기본 정보 & 지도 -->
                        <div class="sec-wrap">
                            <section class="base-info-sec">
                                <div class="sec-inner">
                                    <div class="info-wrap" tabindex="1" aria-label="기본정보입니다. 주소, 전화번호, 인근 지하철역을 확인할 수 있습니다.">
                                        <h4 class="section-title sr-only">기본정보</h4>
                                        <ul class="info-list">
                                            <li class="info-item" tabindex="1" aria-label="주소 : <?= $row['address_1']; ?>">
                                                <span class="info-term">주소</span>
                                                <span class="info-desc"><?= $row['address_1']; ?></span>
                                            </li>
                                            <li class="info-item" tabindex="1" aria-label="전화번호 : <?= $T_phone?:'없음'; ?>">
                                                <span class="info-term">전화</span>
                                                <span class="info-desc"><?= $T_phone ? $T_phone : '-'; ?></span>
                                            </li>
                                                    <?php
                                                        if(count($R_is_station) == 0) {
                                                            $T_station = "-";
                                                            $T_station_text = "없음";
                                                        } else {
                                                            foreach ($R_is_station AS $key=>$value) {
                                                                if($value['code'] && $value['line']){
                                                                    $T_station .= "<span class='info-desc subway'>

                                                                    <span class='subway-tag' style='background-color:{$config['cat_station_color'][$value['line']]};'>
                                                                        {$value['line']}
                                                                    </span>
                                                                    <span class='subway-name'>" 
                                                                    .$value['title_'.$GLOBALS['lang_code']]."
                                                                    </span>
                                                                    ".
                                                                    "</span>";
                                                                    $T_station_text .= $T_station_line[$value['line']].$value['title_'.$GLOBALS['lang_code']]." ";
                                                                } else{
                                                                    $T_station = '-';
                                                                    $T_station_text = "없음";
                                                                }
                                                            }
                                                        }
                                                    ?>
                                            <li class="info-item" tabindex="1" aria-label="인근 지하철역 : <?= $T_station_text?:'없음'; ?>">
                                                <span class="info-term">지하철역</span>
                                                <div class="subway-wrap">
                                                    <?= $T_station ?>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="map-wrap" role="group" tabindex="1" aria-label="지도입니다. 확대와 축소 버튼을 사용할 수 있습니다.">
                                        <div class="map-area" id="map">
                                            <!-- 지도 API 또는 정적 이미지 영역 -->
                                        </div>
                                        <!-- 251205 1차 수정 : 구조 변경 -->
                                        <div class="map-control">
                                            <div class="btn-wrap">
                                                <button type="button" class="map-zoom-in-btn"  aria-label="지도 확대 버튼">
                                                    <span class="icon" aria-hidden="true"></span>
                                                    <span>확대</span>
                                                </button>
                                            </div>
                                            <div class="btn-wrap">
                                                <button type="button" class="map-zoom-out-btn"  aria-label="지도 축소 버튼">
                                                    <span class="icon" aria-hidden="true"></span>
                                                    <span>축소</span>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- 251205 1차 수정 -->
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- QR 안내 -->
                        <div class="sec-wrap" tabindex="1" aria-label="QR코드를 스캔해 모바일에서 추가 정보를 확인할 수 있습니다.">
                            <section class="qr-sec">
                                <div class="sec-inner">
                                    <div class="qr-info-wrap">
                                        <h4 class="section-title">
                                            QR코드 스캔을 통해 모바일에서도 추가 정보를 확인하세요.
                                        </h4>
                                        <ul class="qr-guide-list">
                                            <li class="qr-guide-item">
                                                스캔 방법 : 휴대폰 카메라 앱 실행 → QR코드 이미지 스캔
                                            </li>
                                            <li class="qr-guide-item">
                                                Wi-Fi Zone이 아닌 경우 데이터 요금제에 따라 추가 요금이<br> 부과될 수 있습니다.
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="qr-wrap">
                                        <ul class="qr-list">
                                            <li class="qr-item">
                                                <span class="qr-logo google" aria-hidden="true"></span>
                                                <div class="qr-code"  tabindex="1" aria-label="구글 지도 QR코드입니다.">
                                                    <img src="../../assets/images/dummy/google_maps_qr.png" alt="구글 지도 위치 정보 QR코드">
                                                </div>
                                            </li>
                                            <li class="qr-item">
                                                <span class="qr-logo naver" aria-hidden="true"></span>
                                                <div class="qr-code"  tabindex="1" aria-label="네이버 지도 QR코드입니다.">
                                                    <img src="../../assets/images/dummy/naver_map_qr.png" alt="네이버 지도 위치 정보 QR코드">
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </section>
                        </div>
    
                        <!-- 상세 정보 & 무장애 편의정보 -->
                        <?php if($strPictoGram !='' || $row['story'] != '') { ?>
                        <div class="sec-wrap"  tabindex="1" aria-label="상세정보입니다. 상세정보 <?= $row['story']; ?> . 무장애 편의정보 : <?= $strPictoGram_text ? $strPictoGram_text : '-'; ?> ">
                            <section class="detail-sec">
                                <div class="sec-inner">
                                    <h4 class="section-title">상세정보</h4>
                                    <p class="detail-text">
                                        <?= $row['story']; ?>
                                    </p>
                                </div>
                            </section>
                            <?php if($strPictoGram){ ?>
                            <section class="access-sec">
                                <div class="sec-inner">
                                    <h4 class="section-title">무장애 편의정보</h4>
                                    <div class="access-wrap">
                                        <?= $strPictoGram; ?>
                                    </div>
                                </div>
                            </section>
                            <?php } ?>
                        </div>
                        <?php } ?>
                    </div>
                </main>
                <!-- //main -->
    
                <!-- floating button -->
                <div class="floating-btn">
                    <div class="btn-wrap prev">
                        <button type="button" class="sec-move-btn prev" aria-label="이전 섹션으로 이동">
                            <span class="icon" aria-hidden="true"></span>
                            <span class="label">이전</span>
                        </button>
                    </div>
                    <div class="btn-wrap next">
                        <!-- 251205 1차 수정 : icon / label 순서 변경 -->
                        <button type="button" class="sec-move-btn next" aria-label="다음 섹션으로 이동">
                            <span class="icon" aria-hidden="true"></span>
                            <span class="label">다음</span>
                        </button>
                        <!-- //1차 수정 -->
                    </div>
                </div>
                <!-- //floating button -->
    
                <!-- bottom nav -->
                <nav class="bottom-nav" aria-label="하단 주요 메뉴">
                    <?php include __DIR__.'/../../html/include/bottom_nav.html'; ?>
                </nav>
                <!-- bottom nav -->
                 
                </div>

                <!-- 공통 모달 -->
                <div class="global-modal-wrap">
                    <?php include __DIR__.'/../../html/include/modal.html'; ?>
                </div>
                <!-- //공통 모달 -->
                
                <!-- footer -->
                <footer class="footer">
                    <?php include __DIR__.'/../../html/include/footer.html'; ?>
                </footer>
                <!-- //footer -->
            </div>

            <!-- 251215 로딩화면 추가 -->
            <!-- 로딩화면 -->
            <div class="loading is-hidden" role="status" aria-live="polite" aria-atomic="true">
                <?php include __DIR__.'/../include/loading.html'; ?>
            </div>

            <!-- 상하좌우 이동 버튼 -->
            <div class="viewport-controller">
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-up" aria-label="위로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">위로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-left" aria-label="좌측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">좌측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-right" aria-label="우측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">우측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-down" aria-label="아래로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">아래로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control zoom-exit-btn">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">돋보기 종료</span>
                    </button>
                </div>
            </div>
            <!-- //상하좌우 이동 버튼 -->
        </div>
    </div>
    <script>
        var map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(<?= $row['coordinate_y'] ?>, <?= $row['coordinate_x'] ?>),
            zoom: 15,
            minZoom:12,
            maxZoom: 18, 

            // 확대/축소 제어
            scrollWheel: false,              // 마우스 휠 확대/축소 비활성화
            disableDoubleClickZoom: true,    // 더블클릭 확대 비활성화
            pinchZoom: false,                // 터치 핀치 줌 비활성화 (키오스크 중요)

            // (선택) 기본 줌 컨트롤 숨기기
            zoomControl: false
        });

        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(<?= $row['coordinate_y'] ?>, <?= $row['coordinate_x'] ?>),
            map: map
        });

        document.querySelector('.map-zoom-in-btn')?.addEventListener('click', function () {
            map.setZoom(map.getZoom() + 1, true);
        });

        document.querySelector('.map-zoom-out-btn')?.addEventListener('click', function () {
            map.setZoom(map.getZoom() - 1, true); // true = 애니메이션
        });
    </script>
</body>
</html>