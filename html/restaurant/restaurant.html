<?php
    include_once __DIR__.'/../../config/common.php';

    $city_id = $_GET['city_id'] ?? 1;
    $sigungu_id = $_GET['sigungu_id'] ?? '';
    $current_page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
    $GLOBALS['lang_code'] = $GLOBALS['lang_code'] ?? 0;
    $cat1 = $_GET['cat1'] ?? '';
    $q    = $_GET['q']    ?? '';
    $lowMode = $_COOKIE['lowMode'] ?? '0';
    $perPage = ($lowMode === '1') ? 3 : 9;

    $filters = [
        ''        => '전체',
        'musteat' => '지역추천 맛집',
        '한식'     => '한식',
        '중식'     => '중식',
        '일식'     => '일식',
        '양식'     => '양식',
        '베이커리' => '베이커리',
        '기타'     => '기타',
    ];

    if ($q !== '' && isset($filters[$q])) {
        $currentLabel = $filters[$q];
        unset($filters[$q]);

        // 현재 q를 맨 앞에 다시 삽입
        $filters = [$q => $currentLabel] + $filters;
    }

    $A_cities = getCity_rt($GLOBALS['lang_code'],$city_id);
    $A_restaurants = getRestaurants_rt($cat1, $q , $perPage, $current_page, 0, 0, $city_id, $sigungu_id);

    $total        = $A_restaurants['total'];
    $currentPage  = max(1, (int)$current_page);
    $totalPages   = (int)ceil($total / $perPage);

    // 노출할 페이지 범위 (예: 5개)
    $range = 5;
    $startPage = max(1, $currentPage - floor($range / 2));
    $endPage   = min($totalPages, $startPage + $range - 1);
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART TOURIST INFORMATION</title>
    <script src="<?= asset('/assets/js/idleTimer.js') ?>"></script>

    <script>
        (function () {
            try {
                var contrast = localStorage.getItem('contrastMode'); // '1' | '0' | null
                var low      = localStorage.getItem('lowMode');      // '1' | '0' | null
                var voice      = localStorage.getItem('voiceMode');      // '1' | '0' | null
                var last     = localStorage.getItem('lastMode');     // 'contrast' | 'low' | 'none' | null
                var html     = document.documentElement;

                function applyContrast() {
                    html.classList.add('mode-high-contrast');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-voice');
                }

                function applyLow() {
                    html.classList.add('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                    html.classList.remove('mode-voice');
                }

                function applyVoice() {
                    html.classList.add('mode-voice');
                    html.classList.remove('mode-low-posture');
                    html.classList.remove('mode-high-contrast');
                }

                // 1) lastMode 기준으로 우선 적용
                if (last === 'contrast' && contrast === '1') {
                    applyContrast();
                } else if (last === 'low' && low === '1') {
                    applyLow();
                } else if (last === 'voice' && voice === '1') {
                    applyVoice();
                } else {
                    // 2) lastMode 정보가 없거나 꼬였을 때, storage 값으로 복구
                    if (contrast === '1' && low !== '1' && voice !== '1') {
                        applyContrast();
                        localStorage.setItem('lastMode', 'contrast');
                    } else if (low === '1' && contrast !== '1' && voice !== '1') {
                        applyLow();
                        localStorage.setItem('lastMode', 'low');
                    } else if (voice === '1' && contrast !== '1' && low !== '1') {
                        applyVoice();
                        localStorage.setItem('lastMode', 'voice');
                    } else {
                        // 둘 다 1이거나 둘 다 0/없음 → 안전하게 일반 모드
                        html.classList.remove('mode-low-posture');
                        html.classList.remove('mode-high-contrast');
                        html.classList.remove('mode-voice');
                        localStorage.setItem('lastMode', 'none');
                    }
                }
            } catch (e) {
                // localStorage 사용 불가 시 그냥 무시
            }
        })();
    </script>

    <link rel="stylesheet" href="<?= asset('/assets/scss/vendors/swiper-bundle.min.css') ?>">
    <link rel="stylesheet" href="<?= asset('/assets/scss/main.css') ?>">

    <script src="<?= asset('/assets/js/vendor/jquery-3.7.1.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/vendor/swiper-bundle.min.js') ?>"></script>
    <script src="<?= asset('/assets/js/common.js') ?>"></script>
    <script src="<?= asset('/assets/js/zoom.js') ?>"></script>
    <script src="<?= asset('/assets/js/tab.js') ?>"></script>
    <script src="<?= asset('/assets/js/select.js') ?>"></script>
    <script src="<?= asset('/assets/js/filter.js') ?>"></script>
    <script src="<?= asset('/assets/js/modal.js') ?>"></script>
    <script src="<?= asset('/assets/js/volume.js') ?>"></script>
</head>
<body data-tts-summary="음식점 안내 화면입니다. 주변 식당 목록을 확인할 수 있습니다.">
    <div class="zoom-viewport" aria-label="확대 가능한 화면">
        <div class="zoom-move-wrap h933">
            <div class="zoom-canvas">
                <div class="modal-background">
                    <!-- header -->
                    <header class="header">
                        <?php include __DIR__.'/../../html/include/header.html'; ?>
                    </header>
                    <!-- //header -->
                
                    <!-- sub header -->
                    <div class="sub-header">
                        <div class="sub-hd-inner">
                            <h2 class="page-title">음식점</h2>
                        </div>
                    </div>
                    <!-- //sub header -->
                
                    <!-- main -->
                    <main class="main restaurant">
                        <form id="cityForm" action="restaurant.html" method="get">
                            <div class="filter-menu">
                                <div class="sort-wrap">
                                    <div class="sort-inner">
                                        <!-- 251205 1차 수정 : 구조 수정 -->
                                        <div class="select-wrap">
                                            <div class="custom-select sido">
                                                <input type="hidden" name="city_id" id="cityIdInput" value="<?= $city_id ?>">
                                                <input type="hidden" name="sigungu_id" id="sigunguIdInput"
                                                        value="<?= htmlspecialchars($sigungu_id ?? '', ENT_QUOTES, 'UTF-8') ?>">
                                                <input type="hidden"
                                                        name="q"
                                                        id="qInput"
                                                        value="<?= htmlspecialchars($q ?? '', ENT_QUOTES, 'UTF-8') ?>">
                                                <button class="select-item" type="button" aria-haspopup="listbox" aria-expanded="false">서울</button>
                                                <ul class="option-list" role="listbox">
                                                    <li class="move-btn-wrap" role="presentation">
                                                        <button type="button" class="prev-btn">
                                                            <span class="icon" aria-hidden="true"></span>
                                                            <span class="label">이전</span>
                                                        </button>
                                                    </li>
                                                    <?php
                                                        // 도시 목록 배열로 정리
                                                        $cities = [
                                                            1  => '서울',
                                                    2  => '인천',
                                                    31 => '경기도',
                                                    6  => '부산',
                                                    4  => '대구',
                                                    7  => '울산',
                                                    36 => '경상남도',
                                                    35 => '경상북도',
                                                    3  => '대전',
                                                    34 => '충청남도',
                                                    33 => '충청북도',
                                                    5  => '광주',
                                                    38 => '전라남도',
                                                    37 => '전라북도',
                                                    32 => '강원도',
                                                    39 => '제주도',
                                                    ];

                                                    foreach ($cities as $id => $name):
                                                    $isActive = ($city_id == $id);
                                                    ?>
                                                    <li>
                                                        <button type="button"
                                                                role="option"
                                                                data-city-id="<?= $id ?>"
                                                                aria-selected="<?= $isActive ? 'true' : 'false' ?>"
                                                                class="<?= $isActive ? 'is-active' : '' ?>"
                                                                aria-label="<?= htmlspecialchars($name, ENT_QUOTES, 'UTF-8') ?>">
                                                            <?= htmlspecialchars($name, ENT_QUOTES, 'UTF-8') ?>
                                                        </button>
                                                    </li>
                                                    <?php endforeach; ?>

                                                    <li class="move-btn-wrap" role="presentation">
                                                        <button type="button" class="next-btn">
                                                            <span class="icon" aria-hidden="true"></span>
                                                            <span class="label">다음</span>
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="custom-select sigungu">
                                                <button class="select-item" type="button" aria-haspopup="listbox" aria-expanded="false">전체</button>
                                                <ul class="option-list sigungu-list" role="listbox">
                                                    <li class="move-btn-wrap" role="presentation">
                                                        <button type="button" class="prev-btn">
                                                            <span class="icon" aria-hidden="true"></span>
                                                            <span class="label">이전</span>
                                                        </button>
                                                    </li>

                                                    <?php
                                                        // 시군구 목록 가져오기
                                                        $A_cities = getCity_rt($GLOBALS['lang_code'], $city_id);

                                                        // cat=0, code = $city_id 인 구/군 리스트만 추출
                                                        $sigunguList = [];
                                                        if (isset($A_cities[0][$city_id]) && is_array($A_cities[0][$city_id])) {
                                                            $sigunguList = $A_cities[0][$city_id];   // [id => '종로구', ...]
                                                    }
                                                    ?>
                                                    <!-- 전체 -->
                                                    <li>
                                                        <button type="button"
                                                                role="option"
                                                                data-sigungu-id=""
                                                                class="<?= $sigungu_id === '' ? 'is-active' : '' ?>"
                                                                aria-selected="<?= $sigungu_id === '' ? 'true' : 'false' ?>">
                                                            전체
                                                        </button>
                                                    </li>
                                                    <?php foreach ($sigunguList as $id => $name): ?>
                                                    <li>
                                                        <button type="button"
                                                                role="option"
                                                                data-sigungu-id="<?= htmlspecialchars($id, ENT_QUOTES, 'UTF-8') ?>"
                                                                class="<?= ($sigungu_id == $id) ? 'is-active' : '' ?>"
                                                                aria-selected="<?= ($sigungu_id == $id) ? 'true' : 'false' ?>"
                                                                aria-label="<?= htmlspecialchars($name, ENT_QUOTES, 'UTF-8') ?>">
                                                            <?= htmlspecialchars($name, ENT_QUOTES, 'UTF-8') ?>
                                                        </button>
                                                    </li>
                                                    <?php endforeach; ?>

                                                    <li class="move-btn-wrap" role="presentation">
                                                        <button type="button" class="next-btn">
                                                            <span class="icon" aria-hidden="true"></span>
                                                            <span class="label">다음</span>
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                    </div>
                                    <!-- //1차 수정 -->
                                    <p class="info-text">• 현재 위치와 가까운 순으로 표시됩니다.</p>
                                </div>
                                <div class="dimmed" aria-hidden="true"></div>
                                </div>
                                <div class="filter-list-wrap">
                                    <button type="button" class="filter-move-btn prev" aria-label="이전 카테고리로 이동"></button>
                                    <!-- <ul class="filter-list" role="radiogroup" aria-label="음식점 카테고리">
                                        <li class="<?= $q === '' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="">
                                                전체
                                            </button>
                                        </li>
                                        <li class="<?= $q === 'musteat' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === 'musteat' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="musteat">
                                                지역추천 맛집
                                            </button>
                                        </li>
                                        <li class="<?= $q === '한식' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '한식' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="한식">
                                                한식
                                            </button>
                                        </li>
                                        <li class="<?= $q === '중식' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '중식' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="중식">
                                                중식
                                            </button>
                                        </li>
                                        <li class="<?= $q === '일식' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '일식' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="일식">
                                                일식
                                            </button>
                                        </li>
                                        <li class="<?= $q === '양식' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '양식' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="양식">
                                                양식
                                            </button>
                                        </li>
                                        <li class="<?= $q === '베이커리' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '베이커리' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="베이커리">
                                                베이커리
                                            </button>
                                        </li>
                                        <li class="<?= $q === '기타' ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $q === '기타' ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="기타">
                                                기타
                                            </button>
                                        </li>
                                    </ul> -->
                                    <ul class="filter-list" role="radiogroup" aria-label="음식점 카테고리">
                                    <?php foreach ($filters as $value => $label): 
                                        $isActive = ($q === $value);
                                    ?>
                                        <li class="<?= $isActive ? 'is-active' : '' ?>">
                                            <button type="button"
                                                    role="radio"
                                                    aria-checked="<?= $isActive ? 'true' : 'false' ?>"
                                                    class="filter-btn"
                                                    data-q="<?= htmlspecialchars($value, ENT_QUOTES, 'UTF-8') ?>"
                                                    aria-label="<?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?>">
                                                <?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?>
                                            </button>
                                        </li>
                                    <?php endforeach; ?>
                                    </ul>
                                    <button type="button" class="filter-move-btn next" aria-label="다음 카테고리로 이동"></button>
                                </div>
                                <div class="filter-cont">
                                    <!-- 음식점 리스트 출력 영역 -->
                                    <section class="filter-panel">
                                        <?php if(count($A_restaurants['data']) > 0) { ?>
                                        <ul class="card-list"  tabindex="1" aria-label="음식점 목록입니다. 원하는 음식점을 선택해 상세 정보를 확인하세요.">
                                            <?php foreach (($A_restaurants['data'] ?? []) as $key => $value) { ?>
                                                <li class="card">
                                                    <!-- 251114 개발 시 href 실제 URL로 변경 필요 -->
                                                    <!-- 251114 개발 시 aria-label은 장소명 기반으로 동적 생성 필요: "{장소명} 상세 정보 보기" -->
                                                    <a class="card-link" href="./restaurant_detail.html?id=<?= $value['store_id']; ?>" aria-label="<?= $value['store_name'] ?> 상세 화면으로 이동합니다.">
                                                        <div class="card-thumbnail">
                                                            <!-- 251114 개발 시 alt는 장소명 기반으로 동적 생성 필요: "{장소명} 이미지" -->
                                                            <img src="<?= $value['image'] ?>" alt="<?= $value['store_name'] ?> 이미지">
                                                        </div>
                                                        <div class="card-info">
                                                            <h3 class="card-title"><?= $value['store_name'] ?></h3>
                                                            <ul class="card-meta">
                                                                <li class="card-meta-item">
                                                                    <span class="card-term">카테고리</span>
                                                                    <span class="card-desc"><?= $value['category']; ?></span>
                                                                </li>
                                                                <li class="card-meta-item">
                                                                    <span class="card-term">대표메뉴</span>
                                                                    <span class="card-desc"><?= $value['main_nemu']?$value['main_nemu']:'-'; ?></span>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </a>
                                                </li>
                                            <?php } ?>
                                        </ul>
                                        <?php } else { ?>
                                        <div class="empty-screen" tabindex="1" aria-label="음식점 목록입니다. 검색결과가 없습니다.">
                                            <p class="empty-info">검색결과가 없습니다.</p>
                                        </div>
                                        <?php } ?>
                                    </section>
                                </div>
                                <?php if ($totalPages > 1){ ?>
                                <div class="pagination" role="navigation" aria-label="페이지 이동">
                                    <?php
                                    $pagination = new Zebra_Pagination();
                                    $pagination->records($A_restaurants['total']);
                                    $pagination->records_per_page($perPage);

                                    $pagination->render();
                                    ?>
                                </div>
                                <?php } ?>
                            </div>
                        </form>
                    </main>
                    <!-- //main -->
    
                    <!-- bottom nav -->
                    <nav class="bottom-nav" aria-label="하단 주요 메뉴">
                        <?php include __DIR__.'/../../html/include/bottom_nav.html'; ?>
                    </nav>
                    <!-- bottom nav -->
                 
                </div>

                <!-- 공통 모달 -->
                <div class="global-modal-wrap">
                    <?php include __DIR__.'/../../html/include/modal.html'; ?>
                </div>
                <!-- //공통 모달 -->
                
                <!-- footer -->
                <footer class="footer">
                    <?php include __DIR__.'/../../html/include/footer.html'; ?>
                </footer>
                <!-- //footer -->
            </div>

            <!-- 251215 로딩화면 추가 -->
            <!-- 로딩화면 -->
            <div class="loading is-hidden" role="status" aria-live="polite" aria-atomic="true">
                <?php include __DIR__.'/../include/loading.html'; ?>
            </div>

            <!-- 상하좌우 이동 버튼 -->
            <div class="viewport-controller">
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-up" aria-label="위로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">위로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-left" aria-label="좌측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">좌측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-right" aria-label="우측으로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">우측으로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control move-down" aria-label="아래로 이동">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">아래로</span>
                    </button>
                </div>
                <div class="btn-wrap">
                    <button type="button" class="zoom-control zoom-exit-btn">
                        <span class="icon" aria-hidden="true"></span>
                        <span class="label">돋보기 종료</span>
                    </button>
                </div>
            </div>
            <!-- //상하좌우 이동 버튼 -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form      = document.getElementById('cityForm');
            const cityInput = document.getElementById('cityIdInput');
            const optionButtons = document.querySelectorAll('.option-list [data-city-id]');
            const sigunguInput   = document.getElementById('sigunguIdInput');
            const sigunguButtons = document.querySelectorAll('.sigungu-list [data-sigungu-id]');
            const qInput       = document.getElementById('qInput');


            optionButtons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const cityId = this.getAttribute('data-city-id');

                    const isActiveVoice = $('html').hasClass('mode-voice');
                    if (isActiveVoice) {
                        TTS.speak('지역이 변경되었습니다. 음식점 목록을 새로 불러옵니다.');
                    }

                    // hidden input에 값 넣기
                    cityInput.value = cityId;

                    if (sigunguInput) sigunguInput.value = '';
                    if (qInput) qInput.value = '';

                    // active 표시 갱신
                    optionButtons.forEach(function (b) {
                        b.classList.remove('is-active');
                    });
                    this.classList.add('is-active');

                    // 바로 submit
                    setTimeout(() => {
                        form.submit();
                    }, 400);
                });
            });

            sigunguButtons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const sigunguId = this.getAttribute('data-sigungu-id') || '';

                    const isActiveVoice = $('html').hasClass('mode-voice');
                    if (isActiveVoice) {
                        TTS.speak('구·군이 변경되었습니다. 목록을 새로 불러옵니다.');
                    }

                    if (sigunguInput) {
                        sigunguInput.value = sigunguId;
                    }

                    sigunguButtons.forEach(function (b) {
                        b.classList.remove('is-active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('is-active');
                    this.setAttribute('aria-selected', 'true');

                    // 페이지 1로 리셋하고 싶으면 (선택)
                    const pageInput = form.querySelector('input[name="page"]');
                    if (pageInput) pageInput.value = 1;

                    setTimeout(() => {
                        form.submit();
                    }, 400);
                });
            });

            document.querySelectorAll('.filter-list-wrap .filter-list .filter-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const q = this.getAttribute('data-q') || '';
                    if (qInput) {
                        qInput.value = q;
                    }

                    // is-active / aria-checked 갱신
                    document.querySelectorAll('.filter-list-wrap .filter-list li').forEach(function (li) {
                        li.classList.remove('is-active');
                    });
                    document.querySelectorAll('.filter-list-wrap .filter-list .filter-btn').forEach(function (b) {
                        b.setAttribute('aria-checked', 'false');
                    });

                    this.closest('li').classList.add('is-active');
                    this.setAttribute('aria-checked', 'true');

                    // 페이지 1로 리셋 (선택사항)
                    const pageInput = form.querySelector('input[name="page"]');
                    if (pageInput) pageInput.value = 1;

                    form.submit();
                });
            });
        });
    </script>
</body>
</html>